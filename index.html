<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Bazar Oyunu â€“ Online</title>
<style>
body{margin:0;font-family:Arial;background:#0b132b;color:white}
#top{background:#000a;padding:10px;display:flex;justify-content:space-between}
.box{background:#1c2541;margin:15px;padding:15px;border-radius:10px}
button,input,select{padding:7px;margin:4px;border-radius:5px;border:none}
button{background:#5bc0be;color:black;cursor:pointer}
.item{background:#3a506b;padding:8px;margin:6px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center}
.admin{background:#fca311;color:black}
input.priceInput{width:60px;margin-left:10px}
</style>

<!-- Firebase scripts -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// --- FIREBASE CONFIG ---
const firebaseConfig = {
    apiKey: "AIzaSyCCj0jBFuP1bKjOXB_-WwTMOMcJ5BSwT_I",
    authDomain: "pazar-oyun.firebaseapp.com",
    databaseURL: "https://pazar-oyun-default-rtdb.firebaseio.com",
    projectId: "pazar-oyun",
    storageBucket: "pazar-oyun.firebasestorage.app",
    messagingSenderId: "2500103464",
    appId: "1:2500103464:web:641cb188ee8de73293541d",
    measurementId: "G-CJM1MC5ZSJ"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- GLOBAL --- 
let currentUser = null;
let admin = "admin"; // SÉ™nin admin istifadÉ™Ã§i adÄ±, istÉ™yÉ™ gÃ¶rÉ™ dÉ™yiÅŸdir
const ADMIN_START_MONEY = 999999999;

// --- DOM ELEMENTS ---
const userInfo = document.getElementById("userInfo");
const userMoneyDisplay = document.getElementById("userMoney");
const loginBox = document.getElementById("loginBox");
const menu = document.getElementById("menu");
const wholesaleItems = document.getElementById("wholesaleItems");
const myItems = document.getElementById("myItems");
const globalItems = document.getElementById("globalItems");
const sendUser = document.getElementById("sendUser");
const sendAmount = document.getElementById("sendAmount");
const adminMoneyDisplay = document.getElementById("adminMoneyDisplay");
const adminUsers = document.getElementById("adminUsers");
const adminWholesale = document.getElementById("adminWholesale");

// --- LOGIN ---
function login(){
    let u = document.getElementById("username").value.trim();
    let p = document.getElementById("password").value;
    if(!u||!p){ alert("BoÅŸ ola bilmÉ™z"); return; }

    currentUser = u;
    const userRef = db.ref("users/" + u);

    userRef.get().then(snapshot=>{
        if(!snapshot.exists()){
            // Yeni istifadÉ™Ã§i
            let startMoney = (u===admin ? ADMIN_START_MONEY : 10);
            userRef.set({password:p, money:startMoney, stock:{}});
            alert(u===admin ? "Admin oldunuz" : "Yeni istifadÉ™Ã§i yaradÄ±ldÄ±, pul: 10 AZN");
        } else {
            // Var â†’ ÅŸifrÉ™ yoxla
            if(snapshot.val().password!==p){ alert("ÅifrÉ™ sÉ™hvdir"); return; }
        }
        start();
    });
}

// --- LOGOUT ---
function logout(){
    currentUser = null;
    location.reload();
}

// --- START ---
function start(){
    loginBox.style.display="none";
    menu.style.display="block";
    userInfo.innerText = currentUser + (currentUser===admin?" (ADMIN)":"");
    updateUserMoney();
    loadWholesale();
    loadMy();
    loadMarket();
    loadSendUsers();
    loadAdminPanel();
    show('wholesale');
}

// --- SHOW ---
function show(id){
    document.querySelectorAll(".box").forEach(b=>b.style.display="none");
    menu.style.display="block";
    document.getElementById(id).style.display="block";
}

// --- UPDATE USER MONEY ---
function updateUserMoney(){
    db.ref("users/" + currentUser + "/money").get().then(snap=>{
        let money = (currentUser===admin) ? ADMIN_START_MONEY : (snap.exists() ? snap.val() : 0);
        userMoneyDisplay.innerText = money;
    });
}

// --- LOAD WHOLESALE ---
function loadWholesale(){
    db.ref("wholesale").get().then(snap=>{
        let data = snap.exists() ? snap.val() : {};
        wholesaleItems.innerHTML = "";
        Object.keys(data).forEach((k)=>{
            let item = data[k];
            let btn = currentUser===admin ? `<button onclick="deleteWholesale('${k}')">Sil</button>` 
                                           : `<button onclick="buyWholesale('${k}')">Al</button>`;
            wholesaleItems.innerHTML += `<div class="item">${item.name} | QiymÉ™t: ${item.price} AZN ${btn}</div>`;
        });
    });
}

// --- ADD WHOLESALE (Admin) ---
function addWholesale(){
    if(currentUser!==admin) return;
    let name = document.getElementById("wName").value.trim();
    let price = Number(document.getElementById("wPrice").value);
    if(!name||price<=0){ alert("DÃ¼zgÃ¼n daxil et"); return; }
    let key = db.ref("wholesale").push().key;
    db.ref("wholesale/" + key).set({name, price});
    document.getElementById("wName").value=""; document.getElementById("wPrice").value="";
    loadWholesale();
}

// --- DELETE WHOLESALE ---
function deleteWholesale(key){
    db.ref("wholesale/" + key).remove();
    loadWholesale();
}

// --- BUY WHOLESALE ---
function buyWholesale(key){
    db.ref("wholesale/" + key).get().then(snap=>{
        if(!snap.exists()) return;
        let item = snap.val();
        let userRef = db.ref("users/" + currentUser);
        userRef.get().then(usnap=>{
            let money = usnap.val().money;
            if(money < item.price){ alert("Pul Ã§atmÄ±r"); return; }
            money -= item.price;
            userRef.child("money").set(money);
            // Stock É™lavÉ™ et
            let stockKey = db.ref("users/" + currentUser + "/stock").push().key;
            db.ref("users/" + currentUser + "/stock/" + stockKey).set(item);
            // Admin pul É™lavÉ™
            if(currentUser!==admin) db.ref("users/" + admin + "/money").get().then(a=>{
                db.ref("users/" + admin + "/money").set(a.val() + item.price);
            });
            // ToptancÄ±dan sil
            db.ref("wholesale/" + key).remove();
            loadWholesale(); loadMy(); updateUserMoney();
        });
    });
}

// --- LOAD MY STOCK ---
function loadMy(){
    db.ref("users/" + currentUser + "/stock").get().then(snap=>{
        let data = snap.exists() ? snap.val() : {};
        myItems.innerHTML = "";
        Object.keys(data).forEach((k)=>{
            let item = data[k];
            myItems.innerHTML += `<div class="item">
                ${item.name} | QiymÉ™t: ${item.price} AZN
                <input class="priceInput" type="number" placeholder="SatÄ±ÅŸ AZN" id="sellPrice${k}">
                <button onclick="sellItem('${k}')">Sat</button>
            </div>`;
        });
    });
}

// --- SELL ITEM ---
function sellItem(k){
    let price = Number(document.getElementById("sellPrice"+k).value);
    if(price<=0){ alert("QiymÉ™ti dÃ¼zgÃ¼n daxil et"); return; }
    db.ref("users/" + currentUser + "/stock/" + k).get().then(snap=>{
        let item = snap.val();
        db.ref("users/" + currentUser + "/stock/" + k).remove();
        // MarketÉ™ É™lavÉ™ et
        let key = db.ref("market").push().key;
        db.ref("market/" + key).set({...item, price, seller:currentUser});
        loadMy(); loadMarket();
    });
}

// --- LOAD MARKET ---
function loadMarket(){
    db.ref("market").get().then(snap=>{
        let data = snap.exists() ? snap.val() : {};
        globalItems.innerHTML = "";
        Object.keys(data).forEach((k)=>{
            let item = data[k];
            let btn = `<button onclick="buyFromMarket('${k}')">Al</button>`;
            if(currentUser===admin) btn = `<button onclick="buyFromMarket('${k}')">Al</button> <button onclick="deleteMarket('${k}')">Sil</button>`;
            globalItems.innerHTML += `<div class="item">${item.name} | QiymÉ™t: ${item.price} AZN | SatÄ±cÄ±: ${item.seller} ${btn}</div>`;
        });
    });
}

// --- DELETE MARKET ITEM ---
function deleteMarket(k){
    db.ref("market/" + k).remove();
    loadMarket();
}

// --- BUY FROM MARKET ---
function buyFromMarket(k){
    db.ref("market/" + k).get().then(snap=>{
        if(!snap.exists()) return;
        let item = snap.val();
        let userRef = db.ref("users/" + currentUser);
        userRef.get().then(u=>{
            let money = u.val().money;
            if(currentUser!==admin && money < item.price){ alert("Pul Ã§atmÄ±r"); return; }
            if(currentUser!==admin) userRef.child("money").set(money - item.price);
            // SatÄ±cÄ±ya pul É™lavÉ™
            if(currentUser!==item.seller) {
                db.ref("users/" + item.seller + "/money").get().then(s=>{
                    db.ref("users/" + item.seller + "/money").set(s.val() + item.price);
                });
            }
            db.ref("users/" + currentUser + "/stock").push().set({name:item.name, price:item.price});
            db.ref("market/" + k).remove();
            loadMy(); loadMarket(); updateUserMoney();
        });
    });
}

// --- SEND MONEY ---
function loadSendUsers(){
    db.ref("users").get().then(snap=>{
        let data = snap.exists() ? snap.val() : {};
        sendUser.innerHTML = "";
        Object.keys(data).forEach(u=>{
            if(u!==currentUser) sendUser.innerHTML += `<option value="${u}">${u}</option>`;
        });
    });
}

function sendMoney(){
    let user = sendUser.value;
    let amount = Number(sendAmount.value);
    if(!user || amount<=0){ alert("DÃ¼zgÃ¼n daxil et"); return; }
    let senderRef = db.ref("users/" + currentUser);
    senderRef.get().then(snap=>{
        let money = snap.val().money;
        if(currentUser!==admin && money < amount){ alert("Pul Ã§atmÄ±r"); return; }
        if(currentUser!==admin) senderRef.child("money").set(money - amount);
        else senderRef.child("money").set(money - amount);
        db.ref("users/" + user + "/money").get().then(u=>{
            db.ref("users/" + user + "/money").set(u.val() + amount);
            alert(amount + " AZN gÃ¶ndÉ™rildi " + user + "-É™");
            loadSendUsers(); updateUserMoney();
        });
    });
}

// --- ADMIN PANEL ---
function loadAdminPanel(){
    if(currentUser!==admin) return;
    // Admin users
    db.ref("users").get().then(snap=>{
        let data = snap.exists() ? snap.val() : {};
        adminUsers.innerHTML = "<ul>";
        Object.keys(data).forEach(u=>{
            let info = data[u];
            let count = info.stock ? Object.keys(info.stock).length : 0;
            adminUsers.innerHTML += `<li>${u} - Pul: ${info.money} AZN | MÉ™hsullar: ${count}</li>`;
        });
        adminUsers.innerHTML += "</ul>";
    });
    // Admin money
    db.ref("users/" + admin + "/money").get().then(snap=>{
        adminMoneyDisplay.innerText = snap.exists() ? snap.val() : ADMIN_START_MONEY;
    });
    // Wholesale
    db.ref("wholesale").get().then(snap=>{
        let data = snap.exists() ? snap.val() : {};
        adminWholesale.innerHTML = "<h4>Topdan mallar:</h4>";
        Object.keys(data).forEach(k=>{
            let item = data[k];
            adminWholesale.innerHTML += `<div class="item">${item.name} | QiymÉ™t: ${item.price} AZN
                <button onclick="deleteWholesale('${k}')">Sil</button></div>`;
        });
    });
}

// --- PAGE LOAD ---
</script>
</head>
<body>

<div id="top">
<span id="userInfo">GiriÅŸ yoxdur</span>
<span>Pul: <b><span id="userMoney">0</span> AZN</b></span>
</div>

<div class="box" id="loginBox">
<h2>GiriÅŸ / Qeydiyyat</h2>
<input id="username" placeholder="Ä°stifadÉ™Ã§i adÄ±"><br>
<input id="password" type="password" placeholder="ÅifrÉ™"><br>
<button onclick="login()">Daxil ol</button>
</div>

<div class="box" id="menu" style="display:none">
<button onclick="show('wholesale')">ğŸ­ ToptancÄ±</button>
<button onclick="show('myMarket')">ğŸª Ã–z BazarÄ±m</button>
<button onclick="show('globalMarket')">ğŸŒ BazardakÄ± mallar</button>
<button onclick="show('sendMoneyBox')">ğŸ’¸ Pul GÃ¶ndÉ™r</button>
<button onclick="show('adminPanel')">ğŸ‘‘ Admin Panel</button>
<button onclick="logout()">Ã‡Ä±xÄ±ÅŸ</button>
</div>

<div class="box" id="wholesale" style="display:none">
<h3>ğŸ­ ToptancÄ±</h3>
<div id="wholesaleItems"></div>
<input id="wName" placeholder="Topdan mal adÄ±">
<input id="wPrice" type="number" placeholder="Topdan qiymÉ™t AZN">
<button onclick="addWholesale()">ÆlavÉ™ et</button>
</div>

<div class="box" id="myMarket" style="display:none">
<h3>Ã–z BazarÄ±n</h3>
<div id="myItems"></div>
</div>

<div class="box" id="globalMarket" style="display:none">
<h3>ğŸŒ BazardakÄ± Mallar</h3>
<div id="globalItems"></div>
</div>

<div class="box" id="sendMoneyBox" style="display:none">
<h3>ğŸ’¸ Pul GÃ¶ndÉ™r</h3>
<select id="sendUser"></select>
<input type="number" id="sendAmount" placeholder="MÉ™blÉ™ÄŸ">
<button onclick="sendMoney()">GÃ¶ndÉ™r</button>
</div>

<div class="box admin" id="adminPanel" style="display:none">
<h3>ğŸ‘‘ Admin Panel</h3>
<p>Admin pulu: <b id="adminMoneyDisplay"></b> AZN</p>
<h4>Ä°stifadÉ™Ã§ilÉ™r</h4>
<div id="adminUsers"></div>
<h4>Topdan mallar</h4>
<div id="adminWholesale"></div>
</div>

</body>
</html>

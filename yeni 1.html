<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<title>Bazar Oyunu â€“ Online</title>
<style>
body{margin:0;font-family:Arial;background:#0b132b;color:white}
#top{background:#000a;padding:10px;display:flex;justify-content:space-between}
.box{background:#1c2541;margin:15px;padding:15px;border-radius:10px}
button,input,select{padding:7px;margin:4px;border-radius:5px;border:none}
button{background:#5bc0be;color:black;cursor:pointer}
.item{background:#3a506b;padding:8px;margin:6px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center}
.admin{background:#fca311;color:black}
input.priceInput{width:60px;margin-left:10px}
</style>
</head>
<body>

<div id="top">
<span id="userInfo">GiriÅŸ yoxdur</span>
<span>Pul: <b><span id="userMoney">0</span> AZN</b></span>
</div>

<!-- LOGIN -->
<div class="box" id="loginBox">
<h2>GiriÅŸ / Qeydiyyat</h2>
<input id="username" placeholder="Ä°stifadÉ™Ã§i adÄ±"><br>
<input id="password" type="password" placeholder="ÅifrÉ™"><br>
<button onclick="login()">Daxil ol</button>
</div>

<!-- MENU -->
<div class="box" id="menu" style="display:none">
<button onclick="show('wholesale')">ğŸ­ ToptancÄ±</button>
<button onclick="show('myMarket')">ğŸª Ã–z BazarÄ±m</button>
<button onclick="show('globalMarket')">ğŸŒ BazardakÄ± mallar</button>
<button onclick="show('sendMoneyBox')">ğŸ’¸ Pul GÃ¶ndÉ™r</button>
<button onclick="show('adminPanel')">ğŸ‘‘ Admin Panel</button>
<button onclick="logout()">Ã‡Ä±xÄ±ÅŸ</button>
</div>

<!-- TOPTANCI -->
<div class="box" id="wholesale" style="display:none">
<h3>ğŸ­ ToptancÄ± (Pullu)</h3>
<div id="wholesaleItems"></div>
</div>

<!-- Ã–z bazar -->
<div class="box" id="myMarket" style="display:none">
<h3>Ã–z BazarÄ±n</h3>
<div id="myItems"></div>
</div>

<!-- BazardakÄ± mallar -->
<div class="box" id="globalMarket" style="display:none">
<h3>ğŸŒ BazardakÄ± Mallar</h3>
<div id="globalItems"></div>
</div>

<!-- Pul gÃ¶ndÉ™r -->
<div class="box" id="sendMoneyBox" style="display:none">
<h3>ğŸ’¸ Pul GÃ¶ndÉ™r</h3>
<select id="sendUser"></select>
<input type="number" id="sendAmount" placeholder="MÉ™blÉ™ÄŸ">
<button onclick="sendMoney()">GÃ¶ndÉ™r</button>
</div>

<!-- ADMIN PANEL -->
<div class="box admin" id="adminPanel" style="display:none">
<h3>ğŸ‘‘ Admin Panel</h3>
<p>Admin pulu: <b id="adminMoneyDisplay"></b> AZN</p>
<h4>Ä°stifadÉ™Ã§ilÉ™r</h4>
<div id="adminUsers"></div>
<h4>Topdan mallar</h4>
<input id="wName" placeholder="Topdan mal adÄ±">
<input id="wPrice" type="number" placeholder="Topdan qiymÉ™t AZN">
<button onclick="addWholesale()">ÆlavÉ™ et</button>
<div id="adminWholesale"></div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.6.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_ID",
  appId: "YOUR_APPID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let currentUser = null;
let admin = null;

// SHOW BOX
function show(id){
  document.querySelectorAll(".box").forEach(b=>b.style.display="none");
  document.getElementById(id).style.display="block";
  document.getElementById("menu").style.display="block";
}

// LOGIN
function login(){
  const u = username.value.trim();
  const p = password.value;
  if(!u||!p){alert("BoÅŸ ola bilmÉ™z"); return;}
  
  firebase.database().ref('users/'+u).get().then(snap=>{
    if(!snap.exists()){
      // Yeni istifadÉ™Ã§i
      firebase.database().ref('admin').get().then(aSnap=>{
        if(!aSnap.exists()){
          // Ä°lk admin
          firebase.database().ref('users/'+u).set({password:p,money:999999999,stock:{},isAdmin:true});
          firebase.database().ref('admin').set(u);
          alert("Siz ADMIN oldunuz, pul: 999999999 AZN");
          start(u);
        } else {
          // Yeni normal istifadÉ™Ã§i
          firebase.database().ref('users/'+u).set({password:p,money:10,stock:{},isAdmin:false});
          alert("Yeni istifadÉ™Ã§i yaradÄ±ldÄ±, pul:10 AZN");
          start(u);
        }
      });
    } else {
      const data = snap.val();
      if(data.password!==p){alert("ÅifrÉ™ sÉ™hvdir"); return;}
      start(u);
    }
  });
}

// START
function start(u){
  currentUser=u;
  show('wholesale');
  document.getElementById('loginBox').style.display='none';
  document.getElementById('userInfo').innerText=u;
  firebase.database().ref('admin').get().then(snap=>{
    admin = snap.val();
    if(currentUser===admin) document.getElementById('userInfo').innerText = u+" (ADMIN)";
  });
  loadWholesale();
  loadSendUsers();
}

// LOGOUT
function logout(){ location.reload(); }

// LOAD WHOLESALE
function loadWholesale(){
  const div = document.getElementById('wholesaleItems');
  firebase.database().ref('wholesale').on('value',snap=>{
    div.innerHTML='';
    snap.forEach(c=>{
      const key = c.key;
      const val = c.val();
      let btnBuy = currentUser!==admin?`<button onclick="buyWholesale('${key}')">Al</button>`:'';
      let btnDel = currentUser===admin?`<button onclick="deleteWholesale('${key}')">Sil</button>`:'';
      div.innerHTML += `<div class="item">${val.name} | QiymÉ™t: ${val.price} AZN ${btnBuy}${btnDel}</div>`;
    });
  });
}

// BUY WHOLESALE
function buyWholesale(key){
  const uRef = db.ref('users/'+currentUser);
  db.ref('wholesale/'+key).get().then(itemSnap=>{
    const item = itemSnap.val();
    uRef.get().then(userSnap=>{
      const user = userSnap.val();
      if(user.money<item.price){alert("Pul Ã§atmÄ±r"); return;}
      const stockKey = db.ref('users/'+currentUser+'/stock').push().key;
      db.ref('users/'+currentUser+'/stock/'+stockKey).set(item);
      uRef.update({money:user.money - item.price});
      db.ref('wholesale/'+key).remove();
    });
  });
}

// DELETE WHOLESALE
function deleteWholesale(key){ db.ref('wholesale/'+key).remove(); }

// SEND MONEY
function loadSendUsers(){
  const sel = document.getElementById('sendUser');
  db.ref('users').get().then(snap=>{
    sel.innerHTML='';
    snap.forEach(c=>{
      if(c.key!==currentUser) sel.innerHTML+=`<option value="${c.key}">${c.key}</option>`;
    });
  });
}

function sendMoney(){
  const u = document.getElementById('sendUser').value;
  const amt = Number(document.getElementById('sendAmount').value);
  if(!u || amt<=0){alert("DÃ¼zgÃ¼n daxil et"); return;}
  db.ref('users/'+currentUser).get().then(snap=>{
    const user = snap.val();
    if(user.money<amt){alert("Pul Ã§atmÄ±r"); return;}
    db.ref('users/'+currentUser).update({money:user.money - amt});
    db.ref('users/'+u).get().then(uSnap=>{
      const rUser = uSnap.val();
      db.ref('users/'+u).update({money:rUser.money + amt});
      alert(amt+" AZN gÃ¶ndÉ™rildi "+u+"-É™");
    });
  });
}

// ADD WHOLESALE (ADMIN)
function addWholesale(){
  if(currentUser!==admin) return;
  const name = wName.value;
  const price = Number(wPrice.value);
  if(!name||price<=0){alert("DÃ¼zgÃ¼n daxil et"); return;}
  const key = db.ref('wholesale').push().key;
  db.ref('wholesale/'+key).set({name,price});
  wName.value=''; wPrice.value='';
}
</script>
</body>
</html>
